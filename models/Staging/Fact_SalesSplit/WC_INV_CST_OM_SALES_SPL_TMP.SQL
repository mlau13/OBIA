{{ config (
    materialized="table"
)}}

WITH WC_INV_CST_OM_SALES_SPL_TMP AS
(

select	
	
	STAGING.LINE_ID	   LINE_ID,
	STAGING.CUSTOMER_TRX_LINE_ID	   CUSTOMER_TRX_LINE_ID,
	STAGING.ORIG_SALESPERSON_ID	       ORIG_SALESREP_ID,
	STAGING.SPLIT_SALESPERSON_ID	   SPLIT_SALESREP_ID,
	STAGING.ORIG_SALESFORCE_ACCOUNT_ID	ORIG_SF_ACCOUNT_ID,
	STAGING.SPLIT_SALESFORCE_ACCOUNT_ID	SPLIT_SF_ACCOUNT_ID,
	STAGING.SALES_SPLIT_PERCENTAGE	    SPLIT_PERCENTAGE,
	STAGING.TRX_DATE	                INVOICED_ON_DATE,
	SALESPERSON_LOOKUP.SOURCE_ID	    PERSON_ID,
	 STAGING.TRANSACTION_TYPE	        CM_FLG
from	
( /* Subselect from WR_SDE_ORA_SalesSplitTempTables.WC_INV_CST_OM_SALES_SPL_TMP_EXTRACT
*/


select 
	   

	   
	   OE_ORDER_LINES_ALL.LINE_ID LINE_ID,
	RA_CUSTOMER_TRX_LINES_ALL.CUSTOMER_TRX_LINE_ID CUSTOMER_TRX_LINE_ID,
	WRS_SALES_ORDER_SPLIT_ALL.ORIG_SALESPERSON_ID ORIG_SALESPERSON_ID,
	WRS_SALES_ORDER_SPLIT_ALL.SPLIT_SALESPERSON_ID SPLIT_SALESPERSON_ID,
	WRS_SALES_ORDER_SPLIT_ALL.ORIG_SALESFORCE_ACCOUNT_ID ORIG_SALESFORCE_ACCOUNT_ID,
	WRS_SALES_ORDER_SPLIT_ALL.SPLIT_SALESFORCE_ACCOUNT_ID SPLIT_SALESFORCE_ACCOUNT_ID,
	WRS_SALES_ORDER_SPLIT_ALL.SALES_SPLIT_PERCENTAGE SALES_SPLIT_PERCENTAGE,
	RA_CUSTOMER_TRX_ALL.TRX_DATE TRX_DATE,
	DECODE(WRS_SALES_ORDER_SPLIT_ALL.TRANSACTION_TYPE,'CM','Y',NULL) TRANSACTION_TYPE
from	"PC_FIVETRAN_DB"."ERPPRD_ONT"."OE_ORDER_LINES_ALL"   OE_ORDER_LINES_ALL, 
  "PC_FIVETRAN_DB"."ERPPRD_AR"."RA_CUSTOMER_TRX_ALL"   RA_CUSTOMER_TRX_ALL,
   "PC_FIVETRAN_DB"."ERPPRD_AR"."RA_CUSTOMER_TRX_LINES_ALL"   RA_CUSTOMER_TRX_LINES_ALL, 
  "PC_FIVETRAN_DB"."ERPPRD_WRSAPP"."WRS_SALES_ORDER_SPLIT_ALL"   WRS_SALES_ORDER_SPLIT_ALL
where	(1=1)
 And (RA_CUSTOMER_TRX_LINES_ALL.CUSTOMER_TRX_ID=RA_CUSTOMER_TRX_ALL.CUSTOMER_TRX_ID)
 AND (CASE WHEN RA_CUSTOMER_TRX_LINES_ALL.INTERFACE_LINE_CONTEXT  in('ORDER ENTRY','INTERCOMPANY')
  THEN TO_NUMBER (RA_CUSTOMER_TRX_LINES_ALL.INTERFACE_LINE_ATTRIBUTE6)
   END = OE_ORDER_LINES_ALL.LINE_ID (+))
 AND (TO_NUMBER(RA_CUSTOMER_TRX_LINES_ALL.INTERFACE_LINE_ATTRIBUTE6)  = OE_ORDER_LINES_ALL.LINE_ID (+))
AND (WRS_SALES_ORDER_SPLIT_ALL.ORDER_LINE_ID=OE_ORDER_LINES_ALL.LINE_ID)

And (/*
RA_CUSTOMER_TRX_ALL.INTERFACE_HEADER_CONTEXT IN ('ORDER ENTRY', 'PROJECTS INVOICES') OR RA_CUSTOMER_TRX_ALL.INTERFACE_HEADER_CONTEXT IS NULL
*/

 ((RA_CUSTOMER_TRX_ALL.INTERFACE_HEADER_CONTEXT IN
                    ('ORDER ENTRY', 'PROJECTS INVOICES')
              OR     RA_CUSTOMER_TRX_ALL.INTERFACE_HEADER_CONTEXT IS NULL)
                 AND (    RA_CUSTOMER_TRX_LINES_ALL.INTERFACE_LINE_CONTEXT
                             IS NULL
                      OR RA_CUSTOMER_TRX_LINES_ALL.INTERFACE_LINE_CONTEXT <>
                             'OKS CONTRACTS')))







)   STAGING, (

select 	
	RA_SALESREPS_ALL.SALESREP_ID    SALESREP_ID,	JTF_RS_RESOURCE_EXTNS.SOURCE_ID    SOURCE_ID
from	"PC_FIVETRAN_DB"."ERPPRD_JTF"."JTF_RS_SALESREPS"   RA_SALESREPS_ALL, 
  "PC_FIVETRAN_DB"."ERPPRD_JTF"."JTF_RS_RESOURCE_EXTNS" JTF_RS_RESOURCE_EXTNS
where	(1=1)
 And (RA_SALESREPS_ALL.RESOURCE_ID=JTF_RS_RESOURCE_EXTNS.RESOURCE_ID)
And (JTF_RS_RESOURCE_EXTNS.CATEGORY IN ('EMPLOYEE', 'OTHER'))


)   SALESPERSON_LOOKUP
where	(1=1)

 And (STAGING.SPLIT_SALESPERSON_ID=SALESPERSON_LOOKUP.SALESREP_ID)
)
SELECT * FROM WC_INV_CST_OM_SALES_SPL_TMP