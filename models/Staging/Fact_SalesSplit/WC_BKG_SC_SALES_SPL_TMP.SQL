{{ config (
    materialized="table"
)}}

WITH WC_BKG_SC_SALES_SPL_TMP AS
(
    

select	
	DISTINCT
	STAGING.LINE_ID	   LINE_ID,
	STAGING.SALESREP_ID	   SALESREP_ID,
	STAGING.PERCENT	   PERCENT,
	STAGING.DATE_APPROVED	   ORDERED_DATE,
	SALESPERSON_LOOKUP.SOURCE_ID	   PERSON_ID
from	
( /* Subselect from WR_SDE_ORA_SalesSplitTempTables.WC_BKG_SC_SALES_SPL_TMP_EXTRACT
*/


select 
	   

	   
	   TO_CHAR(OKC_K_LINES_B.ID) LINE_ID,
	OKS_K_SALES_CREDITS.CTC_ID SALESREP_ID,
	OKS_K_SALES_CREDITS.PERCENT PERCENT,
	OKC_K_HEADERS_ALL_B.DATE_APPROVED DATE_APPROVED
from	"PC_FIVETRAN_DB"."ERPPRD_OKC"."OKC_K_LINES_B"   OKC_K_LINES_B, 
  "PC_FIVETRAN_DB"."ERPPRD_OKS"."OKS_K_SALES_CREDITS"   OKS_K_SALES_CREDITS, 
  "PC_FIVETRAN_DB"."ERPPRD_OKS"."OKS_K_SALES_CREDITS"   OKS_K_SALES_CREDITS1,
  "PC_FIVETRAN_DB"."ERPPRD_OKC"."OKC_K_HEADERS_ALL_B"   OKC_K_HEADERS_ALL_B
where	(1=1)
 And (OKC_K_LINES_B.DNZ_CHR_ID=OKS_K_SALES_CREDITS.CHR_ID)
AND (OKS_K_SALES_CREDITS1.CLE_ID(+)=OKC_K_LINES_B.ID and OKS_K_SALES_CREDITS1.ID IS NULL)
AND (OKC_K_HEADERS_ALL_B.ID=OKC_K_LINES_B.DNZ_CHR_ID)

And (OKC_K_LINES_B.LSE_ID = 1)
 And (OKS_K_SALES_CREDITS.CLE_ID IS NULL)
 And (OKC_K_HEADERS_ALL_B.DATE_APPROVED IS NOT NULL)
 And (OKC_K_LINES_B.CREATION_DATE > TO_DATE(SUBSTR('2002-01-21 01:39:20',0,19),'YYYY-MM-DD HH24:MI:SS'))




UNION ALL

select 
	   

	   
	   TO_CHAR(OKS_K_SALES_CREDITS.CLE_ID) LINE_ID,
	OKS_K_SALES_CREDITS.CTC_ID SALESREP_ID,
	OKS_K_SALES_CREDITS.PERCENT PERCENT,
	OKC_K_HEADERS_ALL_B.DATE_APPROVED DATE_APPROVED
from	"PC_FIVETRAN_DB"."ERPPRD_OKC"."OKC_K_LINES_B"   OKC_K_LINES_B,
   "PC_FIVETRAN_DB"."ERPPRD_OKS"."OKS_K_SALES_CREDITS"   OKS_K_SALES_CREDITS, 
    "PC_FIVETRAN_DB"."ERPPRD_OKC"."OKC_K_HEADERS_ALL_B"   OKC_K_HEADERS_ALL_B
where	(1=1)
 And (OKC_K_LINES_B.ID=OKS_K_SALES_CREDITS.CLE_ID)
AND (OKC_K_HEADERS_ALL_B.ID=OKC_K_LINES_B.DNZ_CHR_ID)

And (OKC_K_HEADERS_ALL_B.DATE_APPROVED IS NOT NULL)
 And (OKC_K_LINES_B.CREATION_DATE > TO_DATE(SUBSTR('2002-01-21 01:39:20',0,19),'YYYY-MM-DD HH24:MI:SS'))




UNION ALL

select 
	   

	   
	   TO_CHAR(OKC_K_LINES_B.ID) LINE_ID,
	TO_NUMBER(OKC_CONTACTS.OBJECT1_ID1) SALESREP_ID,
	100 PERCENT,
	OKC_K_HEADERS_ALL_B.DATE_APPROVED DATE_APPROVED
from	"PC_FIVETRAN_DB"."ERPPRD_OKC"."OKC_CONTACTS"   OKC_CONTACTS, 
  "PC_FIVETRAN_DB"."ERPPRD_OKC"."OKC_K_LINES_B"   OKC_K_LINES_B, 
  "PC_FIVETRAN_DB"."ERPPRD_OKC"."OKC_K_HEADERS_ALL_B"   OKC_K_HEADERS_ALL_B
where	(1=1)
 And (OKC_K_LINES_B.DNZ_CHR_ID=OKC_CONTACTS.DNZ_CHR_ID(+) 
AND OKC_CONTACTS.CRO_CODE(+) = 'SALESPERSON' AND  
OKC_CONTACTS.JTOT_OBJECT1_CODE(+) = 'OKX_SALEPERS')
AND (OKC_K_HEADERS_ALL_B.ID=OKC_K_LINES_B.DNZ_CHR_ID)

And (OKC_CONTACTS.OBJECT1_ID1 IS NOT NULL)
 And (OKC_K_HEADERS_ALL_B.DATE_APPROVED IS NOT NULL)
 And (OKC_K_LINES_B.ID NOT IN (SELECT 
		OKC_K_LINES_B1.ID 
		FROM 
		"PC_FIVETRAN_DB"."ERPPRD_OKS"."OKS_K_SALES_CREDITS" OKS_K_SALES_CREDITS1,
		"PC_FIVETRAN_DB"."ERPPRD_OKC"."OKC_K_LINES_B" OKC_K_LINES_B1,
		"PC_FIVETRAN_DB"."ERPPRD_OKC"."OKC_K_HEADERS_ALL_B" OKC_K_HEADERS_ALL_B
WHERE
1=1
AND OKC_K_LINES_B1.DNZ_CHR_ID = OKS_K_SALES_CREDITS1.CHR_ID
AND OKC_K_LINES_B1.LSE_ID = 1
AND OKC_K_HEADERS_ALL_B.ID = OKC_K_LINES_B1.DNZ_CHR_ID
AND OKC_K_HEADERS_ALL_B.DATE_APPROVED IS NOT NULL
AND OKS_K_SALES_CREDITS1.CLE_ID IS NULL
AND NOT EXISTS (SELECT 1 FROM "PC_FIVETRAN_DB"."ERPPRD_OKS"."OKS_K_SALES_CREDITS"  OKS_K_SALES_CREDITS2
		WHERE 1=1
		AND OKS_K_SALES_CREDITS2.CLE_ID = OKC_K_LINES_B1.ID)
AND OKC_K_LINES_B1.CREATION_DATE > TO_DATE(SUBSTR('2002-01-21 01:39:20',0,19),'YYYY-MM-DD HH24:MI:SS')
UNION ALL 
SELECT OKS_K_SALES_CREDITS1.CLE_ID FROM
"PC_FIVETRAN_DB"."ERPPRD_OKS"."OKS_K_SALES_CREDITS" OKS_K_SALES_CREDITS1,
"PC_FIVETRAN_DB"."ERPPRD_OKC"."OKC_K_LINES_B" OKC_K_LINES_B1,
"PC_FIVETRAN_DB"."ERPPRD_OKC"."OKC_K_HEADERS_ALL_B" OKC_K_HEADERS_ALL_B
WHERE 
1=1
AND OKC_K_LINES_B1.ID = OKS_K_SALES_CREDITS1.CLE_ID
AND OKC_K_HEADERS_ALL_B.ID = OKC_K_LINES_B1.DNZ_CHR_ID
AND OKC_K_HEADERS_ALL_B.DATE_APPROVED IS NOT NULL
AND OKC_K_LINES_B1.CREATION_DATE > TO_DATE(SUBSTR('2002-01-21 01:39:20',0,19),'YYYY-MM-DD HH24:MI:SS')))
 And (OKC_K_LINES_B.CREATION_DATE > TO_DATE(SUBSTR('2002-01-21 01:39:20',0,19),'YYYY-MM-DD HH24:MI:SS'))







)   STAGING, (

select 	
	RA_SALESREPS_ALL.SALESREP_ID    SALESREP_ID,	JTF_RS_RESOURCE_EXTNS.SOURCE_ID    SOURCE_ID
from	 "PC_FIVETRAN_DB"."ERPPRD_JTF"."JTF_RS_SALESREPS"  RA_SALESREPS_ALL, 
   "PC_FIVETRAN_DB"."ERPPRD_JTF"."JTF_RS_RESOURCE_EXTNS" JTF_RS_RESOURCE_EXTNS
where	(1=1)
 And (RA_SALESREPS_ALL.RESOURCE_ID=JTF_RS_RESOURCE_EXTNS.RESOURCE_ID)
And (JTF_RS_RESOURCE_EXTNS.CATEGORY IN ('EMPLOYEE', 'OTHER'))


)   SALESPERSON_LOOKUP
where	(1=1)

 And (STAGING.SALESREP_ID=SALESPERSON_LOOKUP.SALESREP_ID (+))
)
SELECT * FROM WC_BKG_SC_SALES_SPL_TMP