{{ config (
    materialized="table"
)}}

WITH WC_INV_SC_SALES_SPL_TMP AS
(
    
select	
	DISTINCT
	STAGING.ID	   LINE_ID,
	STAGING.CUSTOMER_TRX_LINE_ID	   CUSTOMER_TRX_LINE_ID,
	STAGING.SALESREP_ID	   SALESREP_ID,
	STAGING.EXTENDED_AMOUNT	  EXTENDED_AMOUNT,
	STAGING.TOTAL_LINE_AMT	   TOTAL_LINE_AMT,
	STAGING.REVENUE_PERCENT_SPLIT	   REVENUE_PERCENT_SPLIT,
	STAGING.TRX_DATE	   INVOICED_ON_DT,
	SALESPERSON_LOOKUP.SOURCE_ID	   PERSON_ID,
	STAGING.CUST_TRX_LINE_SALESREP_ID	  CUST_TRX_LINE_SALESREP_ID,
	STAGING.CM_FLG	   CM_FLG,
	STAGING.count_CM	  COUNT_CM,
	STAGING.count_TOT	 COUNT_TOT
from	
( /* Subselect from WR_SDE_ORA_SalesSplitTempTables.WC_INV_SC_SALES_SPL_TMP_EXTRACT
*/


select 
	   

	   
	   OKC_K_LINES_B.ID ID,
	RA_CUSTOMER_TRX_LINES_ALL.CUSTOMER_TRX_LINE_ID CUSTOMER_TRX_LINE_ID,
	TO_NUMBER(RA_CUST_TRX_LINE_SALESREPS_ALL.SALESREP_ID) SALESREP_ID,
	RA_CUSTOMER_TRX_LINES_ALL.EXTENDED_AMOUNT EXTENDED_AMOUNT,
	SUM(RA_CUSTOMER_TRX_LINES_ALL.EXTENDED_AMOUNT * RA_CUST_TRX_LINE_SALESREPS_ALL.REVENUE_PERCENT_SPLIT / 100) OVER (PARTITION BY OKC_K_LINES_B.ID) TOTAL_LINE_AMT,
	RA_CUSTOMER_TRX_ALL.TRX_DATE TRX_DATE,
	RA_CUST_TRX_LINE_SALESREPS_ALL.CUST_TRX_LINE_SALESREP_ID CUST_TRX_LINE_SALESREP_ID,
	DECODE(RA_CUST_TRX_TYPES_ALL.TYPE,'CM','Y',NULL) CM_FLG,
	COUNT(DECODE(RA_CUST_TRX_TYPES_ALL.TYPE,'CM','Y',NULL)) OVER (PARTITION BY TO_CHAR (OKC_K_LINES_B.ID)) count_CM,
	COUNT (TO_CHAR (OKC_K_LINES_B.ID)) OVER (PARTITION BY TO_CHAR (OKC_K_LINES_B.ID)) count_TOT,
	RA_CUST_TRX_LINE_SALESREPS_ALL.REVENUE_PERCENT_SPLIT REVENUE_PERCENT_SPLIT
from
  	"PC_FIVETRAN_DB"."ERPPRD1_AR"."RA_CUSTOMER_TRX_ALL"   RA_CUSTOMER_TRX_ALL, 
  "PC_FIVETRAN_DB"."ERPPRD1_AR"."RA_CUSTOMER_TRX_LINES_ALL"   RA_CUSTOMER_TRX_LINES_ALL, 
  "PC_FIVETRAN_DB"."ERPPRD1_AR"."RA_CUST_TRX_TYPES_ALL"   RA_CUST_TRX_TYPES_ALL, 
  "PC_FIVETRAN_DB"."ERPPRD1_AR"."RA_CUST_TRX_LINE_SALESREPS_ALL"   RA_CUST_TRX_LINE_SALESREPS_ALL, 
  "PC_FIVETRAN_DB"."ERPPRD1_OKC"."OKC_K_ITEMS"   OKC_K_ITEMS, 
  "PC_FIVETRAN_DB"."ERPPRD1_OKC"."OKC_K_LINES_B"   OKC_K_LINES_B, 
  "PC_FIVETRAN_DB"."ERPPRD1_OKC"."OKC_K_HEADERS_ALL_B"   OKC_K_HEADERS_ALL_B, 
  "PC_FIVETRAN_DB"."ERPPRD1_OKS"."OKS_BILL_CONT_LINES"   OKS_BILL_CONT_LINES, 
  "PC_FIVETRAN_DB"."ERPPRD1_OKS"."OKS_BILL_SUB_LINES"   OKS_BILL_SUB_LINES
where	(1=1)
 And (RA_CUSTOMER_TRX_LINES_ALL.CUSTOMER_TRX_LINE_ID=RA_CUST_TRX_LINE_SALESREPS_ALL.CUSTOMER_TRX_LINE_ID)
AND (RA_CUSTOMER_TRX_LINES_ALL.CUSTOMER_TRX_ID=RA_CUSTOMER_TRX_ALL.CUSTOMER_TRX_ID)
AND (RA_CUSTOMER_TRX_ALL.CUST_TRX_TYPE_ID=RA_CUST_TRX_TYPES_ALL.CUST_TRX_TYPE_ID AND RA_CUSTOMER_TRX_ALL.ORG_ID=RA_CUST_TRX_TYPES_ALL.ORG_ID)
AND (RA_CUSTOMER_TRX_LINES_ALL.SOURCE_DATA_KEY1=OKS_BILL_CONT_LINES.CLE_ID)
AND (RA_CUSTOMER_TRX_LINES_ALL.SOURCE_DATA_KEY2=OKS_BILL_SUB_LINES.BCL_ID)
AND (OKS_BILL_CONT_LINES.ID=OKS_BILL_SUB_LINES.BCL_ID)
AND (OKC_K_LINES_B.ID=OKS_BILL_SUB_LINES.CLE_ID)
AND (OKC_K_LINES_B.ID=OKC_K_ITEMS.CLE_ID)
AND (OKC_K_LINES_B.DNZ_CHR_ID=OKC_K_HEADERS_ALL_B.ID)

And (RA_CUSTOMER_TRX_LINES_ALL.INTERFACE_LINE_CONTEXT = 'OKS CONTRACTS')
 And (RA_CUSTOMER_TRX_LINES_ALL.CREATION_DATE >= TO_DATE(SUBSTR('2002-01-21 01:39:20',0,19),'YYYY-MM-DD HH24:MI:SS'))


Group By OKC_K_LINES_B.ID,
 RA_CUSTOMER_TRX_LINES_ALL.CUSTOMER_TRX_LINE_ID,
 TO_NUMBER(RA_CUST_TRX_LINE_SALESREPS_ALL.SALESREP_ID),
 RA_CUSTOMER_TRX_LINES_ALL.EXTENDED_AMOUNT,
 RA_CUSTOMER_TRX_ALL.TRX_DATE,
 RA_CUST_TRX_LINE_SALESREPS_ALL.CUST_TRX_LINE_SALESREP_ID,
 DECODE(RA_CUST_TRX_TYPES_ALL.TYPE,'CM','Y',NULL),
 RA_CUST_TRX_LINE_SALESREPS_ALL.REVENUE_PERCENT_SPLIT





)   STAGING, (

select 	
	RA_SALESREPS_ALL.SALESREP_ID    SALESREP_ID,	JTF_RS_RESOURCE_EXTNS.SOURCE_ID    SOURCE_ID
from	"PC_FIVETRAN_DB"."ERPPRD1_JTF"."JTF_RS_SALESREPS"   RA_SALESREPS_ALL, 
  "PC_FIVETRAN_DB"."ERPPRD1_JTF"."JTF_RS_RESOURCE_EXTNS" JTF_RS_RESOURCE_EXTNS
where	(1=1)
 And (RA_SALESREPS_ALL.RESOURCE_ID=JTF_RS_RESOURCE_EXTNS.RESOURCE_ID)
And (JTF_RS_RESOURCE_EXTNS.CATEGORY IN ('EMPLOYEE', 'OTHER'))


)   SALESPERSON_LOOKUP
where	(1=1)

 And (STAGING.SALESREP_ID=SALESPERSON_LOOKUP.SALESREP_ID (+))


)
SELECT * FROM WC_INV_SC_SALES_SPL_TMP