{{ config (
    materialized="table"
)}}

WITH WC_INV_OM_SALES_SPL_TMP AS
(

select	
	DISTINCT
	STAGING.LINE_ID	   LINE_ID,
	STAGING.CUSTOMER_TRX_LINE_ID	  CUSTOMER_TRX_LINE_ID,
	STAGING.SALESREP_ID	   SALESREP_ID,
	STAGING.EXTENDED_AMOUNT	   EXTENDED_AMOUNT,
	STAGING.TOTAL_LINE_AMT	   TOTAL_LINE_AMT,
	STAGING.REVENUE_PERCENT_SPLIT	  REVENUE_PERCENT_SPLIT,
	STAGING.TRX_DATE	   INVOICED_ON_DT,
	SALESPERSON_LOOKUP.SOURCE_ID	   PERSON_ID,
	STAGING.CUST_TRX_LINE_SALESREP_ID	   CUST_TRX_LINE_SALESREP_ID,
	STAGING.TYPE	   CM_FLG
from	
( /* Subselect from WR_SDE_ORA_SalesSplitTempTables.WC_INV_OM_SALES_SPL_TMP_EXTRACT
*/


select 
	   

	   
	   OE_ORDER_LINES_ALL.LINE_ID LINE_ID,
	RA_CUSTOMER_TRX_LINES_ALL.CUSTOMER_TRX_LINE_ID CUSTOMER_TRX_LINE_ID,
	RA_CUSTOMER_TRX_LINES_ALL.EXTENDED_AMOUNT EXTENDED_AMOUNT,
	SUM(RA_CUSTOMER_TRX_LINES_ALL.EXTENDED_AMOUNT * RA_CUST_TRX_LINE_SALESREPS_ALL.REVENUE_PERCENT_SPLIT/100) over (PARTITION BY OE_ORDER_LINES_ALL.LINE_ID) TOTAL_LINE_AMT,
	RA_CUST_TRX_LINE_SALESREPS_ALL.REVENUE_PERCENT_SPLIT REVENUE_PERCENT_SPLIT,
	RA_CUSTOMER_TRX_ALL.TRX_DATE TRX_DATE,
	RA_CUST_TRX_LINE_SALESREPS_ALL.SALESREP_ID SALESREP_ID,
	RA_CUST_TRX_LINE_SALESREPS_ALL.CUST_TRX_LINE_SALESREP_ID CUST_TRX_LINE_SALESREP_ID,
	DECODE(RA_CUST_TRX_TYPES_ALL.TYPE,'CM','Y',NULL) TYPE
from	"PC_FIVETRAN_DB"."ERPPRD_AR"."RA_CUSTOMER_TRX_ALL"   RA_CUSTOMER_TRX_ALL, 
  "PC_FIVETRAN_DB"."ERPPRD_AR"."RA_CUSTOMER_TRX_LINES_ALL"   RA_CUSTOMER_TRX_LINES_ALL, 
  "PC_FIVETRAN_DB"."ERPPRD_AR"."RA_CUST_TRX_TYPES_ALL"   RA_CUST_TRX_TYPES_ALL, 
  "PC_FIVETRAN_DB"."ERPPRD_AR"."RA_CUST_TRX_LINE_SALESREPS_ALL"   RA_CUST_TRX_LINE_SALESREPS_ALL, 
  "PC_FIVETRAN_DB"."ERPPRD_ONT"."OE_ORDER_HEADERS_ALL"   OE_ORDER_HEADERS_ALL, 
  "PC_FIVETRAN_DB"."ERPPRD_ONT"."OE_ORDER_LINES_ALL" OE_ORDER_LINES_ALL
where	(1=1)
 And (RA_CUSTOMER_TRX_LINES_ALL.CUSTOMER_TRX_LINE_ID=RA_CUST_TRX_LINE_SALESREPS_ALL.CUSTOMER_TRX_LINE_ID(+))
AND (RA_CUSTOMER_TRX_ALL.CUST_TRX_TYPE_ID=RA_CUST_TRX_TYPES_ALL.CUST_TRX_TYPE_ID AND RA_CUST_TRX_TYPES_ALL.ORG_ID=RA_CUSTOMER_TRX_ALL.ORG_ID)
AND (OE_ORDER_HEADERS_ALL.HEADER_ID (+) = OE_ORDER_LINES_ALL.HEADER_ID)
 AND (CASE WHEN RA_CUSTOMER_TRX_LINES_ALL.INTERFACE_LINE_CONTEXT IN('ORDER ENTRY','INTERCOMPANY') THEN TO_NUMBER(RA_CUSTOMER_TRX_LINES_ALL.INTERFACE_LINE_ATTRIBUTE6) END = 
     OE_ORDER_LINES_ALL.LINE_ID(+))
  
 AND (TO_NUMBER(RA_CUSTOMER_TRX_LINES_ALL.INTERFACE_LINE_ATTRIBUTE6)=OE_ORDER_LINES_ALL.LINE_ID(+))
AND (RA_CUSTOMER_TRX_ALL.CUSTOMER_TRX_ID=RA_CUSTOMER_TRX_LINES_ALL.CUSTOMER_TRX_ID)

And (/*
RA_CUSTOMER_TRX_ALL.INTERFACE_HEADER_CONTEXT IN ('ORDER ENTRY', 'PROJECTS INVOICES') OR RA_CUSTOMER_TRX_ALL.INTERFACE_HEADER_CONTEXT IS NULL
*/

 ((RA_CUSTOMER_TRX_ALL.INTERFACE_HEADER_CONTEXT IN
                    ('ORDER ENTRY', 'PROJECTS INVOICES')
              OR     RA_CUSTOMER_TRX_ALL.INTERFACE_HEADER_CONTEXT IS NULL)
                 AND (    RA_CUSTOMER_TRX_LINES_ALL.INTERFACE_LINE_CONTEXT
                             IS NULL
                      OR RA_CUSTOMER_TRX_LINES_ALL.INTERFACE_LINE_CONTEXT <>
                             'OKS CONTRACTS')))
 And (RA_CUSTOMER_TRX_LINES_ALL.CREATION_DATE >= TO_DATE(SUBSTR('2002-01-21 01:39:20',0,19),'YYYY-MM-DD HH24:MI:SS'))


Group By OE_ORDER_LINES_ALL.LINE_ID,
 RA_CUSTOMER_TRX_LINES_ALL.CUSTOMER_TRX_LINE_ID,
 RA_CUSTOMER_TRX_LINES_ALL.EXTENDED_AMOUNT,
 RA_CUST_TRX_LINE_SALESREPS_ALL.REVENUE_PERCENT_SPLIT,
 RA_CUSTOMER_TRX_ALL.TRX_DATE,
 RA_CUST_TRX_LINE_SALESREPS_ALL.SALESREP_ID,
 RA_CUST_TRX_LINE_SALESREPS_ALL.CUST_TRX_LINE_SALESREP_ID,
 DECODE(RA_CUST_TRX_TYPES_ALL.TYPE,'CM','Y',NULL)





)   STAGING, (

select 	
	RA_SALESREPS_ALL.SALESREP_ID    SALESREP_ID,	JTF_RS_RESOURCE_EXTNS.SOURCE_ID    SOURCE_ID
from	 "PC_FIVETRAN_DB"."ERPPRD_JTF"."JTF_RS_SALESREPS"   RA_SALESREPS_ALL, 
  "PC_FIVETRAN_DB"."ERPPRD_JTF"."JTF_RS_RESOURCE_EXTNS" JTF_RS_RESOURCE_EXTNS
where	(1=1)
 And (RA_SALESREPS_ALL.RESOURCE_ID=JTF_RS_RESOURCE_EXTNS.RESOURCE_ID)
And (JTF_RS_RESOURCE_EXTNS.CATEGORY IN ('EMPLOYEE', 'OTHER'))


)   SALESPERSON_LOOKUP
where	(1=1)

 And (STAGING.SALESREP_ID=SALESPERSON_LOOKUP.SALESREP_ID (+))
)
SELECT * FROM WC_INV_OM_SALES_SPL_TMP