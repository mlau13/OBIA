{{ config (
    materialized="table"
)}}

select	
	
	COALESCE(SQ_GL_DAILY_RATES.TO_DATE,(SQ_GL_DAILY_RATES.TO_DATE+1))	   END_DT,
	COALESCE(SQ_GL_DAILY_RATES.CONVERSION_DATE,TO_DATE(SUBSTR('1899-01-01 00:00:00',0,19),'YYYY-MM-DD HH24:MI:SS'))	   EXCH_DT,
	SQ_GL_DAILY_RATES.CONVERSION_RATE	  EXCH_RATE,
	COALESCE(SQ_GL_DAILY_RATES.CONVERSION_DATE,TO_DATE(SUBSTR('1899-01-01 00:00:00',0,19),'YYYY-MM-DD HH24:MI:SS'))	  START_DT,
	COALESCE(SQ_GL_DAILY_RATES.FROM_CURRENCY,'__UNASSIGNED__')	   W_FROM_CURCY_CODE,
	SQ_GL_DAILY_RATES.CONVERSION_TYPE	  RATE_TYPE,
	COALESCE(SQ_GL_DAILY_RATES.TO_CURRENCY,'__UNASSIGNED__')	   W_TO_CURCY_CODE,
	LTRIM(TO_CHAR(SQ_GL_DAILY_RATES.CREATED_BY))	  CREATED_BY_ID,
	LTRIM(TO_CHAR(SQ_GL_DAILY_RATES.LAST_UPDATED_BY))	   CHANGED_BY_ID,
	SQ_GL_DAILY_RATES.CREATION_DATE	   CREATED_ON_DT,
	SQ_GL_DAILY_RATES.LAST_UPDATE_DATE	  CHANGED_ON_DT,
	SQ_GL_DAILY_RATES.DELETE_FLG	  DELETE_FLG,
	SQ_GL_DAILY_RATES.FROM_CURRENCY||'~'||SQ_GL_DAILY_RATES.TO_CURRENCY||'~'||SQ_GL_DAILY_RATES.CONVERSION_TYPE||'~'||(CASE
WHEN 
	SQ_GL_DAILY_RATES.CONVERSION_DATE IS NULL THEN 
	TO_CHAR(TO_DATE(SUBSTR('1899-01-01 00:00:00',0,19),'YYYY-MM-DD HH24:MI:SS'), 'YYYY-MM-DD HH24:MI:SS')
ELSE 
	TO_CHAR(SQ_GL_DAILY_RATES.CONVERSION_DATE, 'YYYY-MM-DD HH24:MI:SS')

END )	   INTEGRATION_ID,
to_varchar(CURRENT_TIMESTAMP, 'yyyy-MM-DD hh:mi:ss') LAST_DATE
from	
( /* Subselect from SDE_ORA_ExchangeRateGeneral_Compress.W_EXCH_RATE_GS_SQ_GL_DAILY_RATES
*/


select 
	   

	   
	   CASE
WHEN FIX_DATE_RANGE.NEXT_DT=CURRENT_DATE-100000 AND FIX_DATE_RANGE.PREV_DT<>CURRENT_DATE-100000 THEN 'Filter'
ELSE 'Keep'
END FILTER,
	FIX_DATE_RANGE.STATUS_CODE STATUS_CODE,
	FIX_DATE_RANGE.LAST_UPDATE_DATE LAST_UPDATE_DATE,
	FIX_DATE_RANGE.CREATION_DATE CREATION_DATE,
	FIX_DATE_RANGE.LAST_UPDATED_BY LAST_UPDATED_BY,
	FIX_DATE_RANGE.TO_CURRENCY TO_CURRENCY,
	FIX_DATE_RANGE.CONVERSION_TYPE CONVERSION_TYPE,
	FIX_DATE_RANGE.CONVERSION_DATE CONVERSION_DATE,
	FIX_DATE_RANGE.CREATED_BY CREATED_BY,
	FIX_DATE_RANGE.CONVERSION_RATE CONVERSION_RATE,
	CASE
WHEN FIX_DATE_RANGE.NEXT_DT=CURRENT_DATE-100000 AND FIX_DATE_RANGE.PREV_DT=CURRENT_DATE-100000 THEN FIX_DATE_RANGE.DATE_FOR_WRAP
ELSE LEAD(FIX_DATE_RANGE.DATE_FOR_WRAP,1) OVER(
	PARTITION BY FIX_DATE_RANGE.FROM_CURRENCY,
	FIX_DATE_RANGE.TO_CURRENCY,
	FIX_DATE_RANGE.CONVERSION_TYPE ORDER BY FIX_DATE_RANGE.FROM_CURRENCY,
	FIX_DATE_RANGE.TO_CURRENCY,
	FIX_DATE_RANGE.CONVERSION_TYPE,
	FIX_DATE_RANGE.CONVERSION_DATE
)
END TO_DATE,
	FIX_DATE_RANGE.FROM_CURRENCY FROM_CURRENCY,
	'0' X_CUSTOM,
	FIX_DATE_RANGE.DELETE_FLG DELETE_FLG
from	
( /* Subselect from SDE_ORA_ExchangeRateGeneral_Compress.W_EXCH_RATE_GS_FIX_DATE_RANGE
*/


select 
	   

	   
	   CALC_DATE_RANGE.FROM_CURRENCY FROM_CURRENCY,
	CALC_DATE_RANGE.CREATED_BY CREATED_BY,
	CALC_DATE_RANGE.LAST_UPDATE_DATE LAST_UPDATE_DATE,
	CALC_DATE_RANGE.CONVERSION_RATE CONVERSION_RATE,
	CALC_DATE_RANGE.CREATION_DATE CREATION_DATE,
	CASE
WHEN CALC_DATE_RANGE.CONVERSION_DATE<>CALC_DATE_RANGE.PREV_DT+1 THEN CURRENT_DATE-100000
ELSE CALC_DATE_RANGE.PREV_DT
END PREV_DT,
	CALC_DATE_RANGE.LAST_UPDATED_BY LAST_UPDATED_BY,
	CALC_DATE_RANGE.CONVERSION_TYPE CONVERSION_TYPE,
	CALC_DATE_RANGE.CONVERSION_DATE CONVERSION_DATE,
	CASE
WHEN CALC_DATE_RANGE.NEXT_DT=CURRENT_DATE-100000 OR CALC_DATE_RANGE.CONVERSION_DATE<>CALC_DATE_RANGE.NEXT_DT-1 THEN CALC_DATE_RANGE.CONVERSION_DATE+1
ELSE CALC_DATE_RANGE.CONVERSION_DATE
END DATE_FOR_WRAP,
	CASE
WHEN CALC_DATE_RANGE.CONVERSION_DATE<>CALC_DATE_RANGE.NEXT_DT-1 THEN CURRENT_DATE-100000
ELSE CALC_DATE_RANGE.NEXT_DT
END NEXT_DT,
	CALC_DATE_RANGE.STATUS_CODE STATUS_CODE,
	CALC_DATE_RANGE.TO_CURRENCY TO_CURRENCY,
	CALC_DATE_RANGE.DELETE_FLG DELETE_FLG
from	
( /* Subselect from SDE_ORA_ExchangeRateGeneral_Compress.W_EXCH_RATE_GS_CALC_DATE_RANGE
*/


select 
	   

	   
	   GL_DAILY_RATES.FROM_CURRENCY FROM_CURRENCY,
	GL_DAILY_RATES.CONVERSION_DATE CONVERSION_DATE,
	GL_DAILY_RATES.CONVERSION_RATE CONVERSION_RATE,
	LEAD(GL_DAILY_RATES.CONVERSION_DATE,1,CURRENT_DATE-100000) OVER(
	PARTITION BY GL_DAILY_RATES.FROM_CURRENCY,
	GL_DAILY_RATES.TO_CURRENCY,
	GL_DAILY_RATES.CONVERSION_TYPE,
	GL_DAILY_RATES.CONVERSION_RATE ORDER BY GL_DAILY_RATES.FROM_CURRENCY,
	GL_DAILY_RATES.TO_CURRENCY,
	GL_DAILY_RATES.CONVERSION_TYPE,
	GL_DAILY_RATES.CONVERSION_DATE,
	GL_DAILY_RATES.CONVERSION_RATE
) NEXT_DT,
	GL_DAILY_RATES.CREATION_DATE CREATION_DATE,
	LAG(GL_DAILY_RATES.CONVERSION_DATE,1,CURRENT_DATE-100000) OVER(
	PARTITION BY GL_DAILY_RATES.FROM_CURRENCY,
	GL_DAILY_RATES.TO_CURRENCY,
	GL_DAILY_RATES.CONVERSION_TYPE,
	GL_DAILY_RATES.CONVERSION_RATE ORDER BY GL_DAILY_RATES.FROM_CURRENCY,
	GL_DAILY_RATES.TO_CURRENCY,
	GL_DAILY_RATES.CONVERSION_TYPE,
	GL_DAILY_RATES.CONVERSION_DATE,
	GL_DAILY_RATES.CONVERSION_RATE
) PREV_DT,
	LAG(GL_DAILY_RATES.CONVERSION_RATE,1,-1) OVER(
	PARTITION BY GL_DAILY_RATES.FROM_CURRENCY,
	GL_DAILY_RATES.TO_CURRENCY,
	GL_DAILY_RATES.CONVERSION_TYPE,
	GL_DAILY_RATES.CONVERSION_RATE ORDER BY GL_DAILY_RATES.FROM_CURRENCY,
	GL_DAILY_RATES.TO_CURRENCY,
	GL_DAILY_RATES.CONVERSION_TYPE,
	GL_DAILY_RATES.CONVERSION_DATE,
	GL_DAILY_RATES.CONVERSION_RATE
) PREV_RATE,
	GL_DAILY_RATES.CONVERSION_TYPE CONVERSION_TYPE,
	
GL_DAILY_RATES.LAST_UPDATE_DATE
 LAST_UPDATE_DATE,
	GL_DAILY_RATES.LAST_UPDATED_BY LAST_UPDATED_BY,
	GL_DAILY_RATES.CREATED_BY CREATED_BY,
	GL_DAILY_RATES.TO_CURRENCY TO_CURRENCY,
	GL_DAILY_RATES.STATUS_CODE STATUS_CODE,
	
'N'
 DELETE_FLG
from	{{ source('GL','GL_DAILY_RATES') }}   GL_DAILY_RATES
where	(1=1)

And (GL_DAILY_RATES.CONVERSION_DATE>CURRENT_DATE-10)







)   CALC_DATE_RANGE
where	(1=1)

And (CALC_DATE_RANGE.CONVERSION_RATE<>CALC_DATE_RANGE.PREV_RATE
OR	CALC_DATE_RANGE.CONVERSION_DATE<>CALC_DATE_RANGE.PREV_DT+1
OR	CALC_DATE_RANGE.CONVERSION_DATE<>CALC_DATE_RANGE.NEXT_DT-1)







)   FIX_DATE_RANGE
where	(1=1)








)   SQ_GL_DAILY_RATES
where	(1=1)
And (SQ_GL_DAILY_RATES.FILTER<>'Filter')





 

