{{ config (
    materialized="table"
)}}

WITH ST_NONUSA AS
(
select	
	DISTINCT
	LKP_RA_SALESREP_TERRITORIES.X_SALESREP_ID	   C1_X_SALESREP_ID,
	LKP_RA_SALESREP_TERRITORIES.X_TERRITORY_ID	   C2_X_TERRITORY_ID,
	SQ_WC_SALESREP_TERRITORY_DS.ORG_ID	   C3_X_ORG_ID,
	LKP_RA_SALESREP_TERRITORIES.X_TOP	   C4_X_TOP,
	LKP_RA_SALESREP_TERRITORIES.X_SUPERGEO	   C5_X_SUPERGEO,
	LKP_RA_SALESREP_TERRITORIES.X_DIVISION	   C6_X_DIVISION,
	LKP_RA_SALESREP_TERRITORIES.X_REGION	   C7_X_REGION,
	LKP_RA_SALESREP_TERRITORIES.X_DISTRICT	   C8_X_DISTRICT,
	LKP_RA_SALESREP_TERRITORIES.X_TERRITORY_NAME	   C9_X_TERRITORY_NAME,
	SQ_WC_SALESREP_TERRITORY_DS.EMPLOYEE_NUMBER	   C10_X_EMP_NUM,
	SQ_WC_SALESREP_TERRITORY_DS.FIRST_NAME	   C11_X_FIRST_NAME,
	SQ_WC_SALESREP_TERRITORY_DS.LAST_NAME	   C12_X_LAST_NAME,
	SQ_WC_SALESREP_TERRITORY_DS.FULL_NAME	   C13_X_FULL_NAME,
	SQ_WC_SALESREP_TERRITORY_DS.CREATED_BY	   C14_CREATED_BY_ID,
	SQ_WC_SALESREP_TERRITORY_DS.LAST_UPDATED_BY	   C15_CHANGED_BY_ID,
	SQ_WC_SALESREP_TERRITORY_DS.CREATION_DATE	   C16_CREATED_ON_DT,
	SQ_WC_SALESREP_TERRITORY_DS.LAST_UPDATE_DATE	   C17_CHANGED_ON_DT,
	SQ_WC_SALESREP_TERRITORY_DS.LAST_UPDATE_DATE	   C18_AUX1_CHANGED_ON_DT,
	SQ_WC_SALESREP_TERRITORY_DS.SALESREP_SDTA	   C19_SRC_EFF_FROM_DT,
	SQ_WC_SALESREP_TERRITORY_DS.SALESREP_EDTA	   C20_SRC_EFF_TO_DT,
	TO_CHAR(SQ_WC_SALESREP_TERRITORY_DS.SALESREP_ID) 	   C21_INTEGRATION_ID,
	SQ_WC_SALESREP_TERRITORY_DS.SALESREP_NUMBER	   C22_X_SALESREP_NUM,
	SQ_WC_SALESREP_TERRITORY_DS.RESOURCE_ID	   C23_X_RESOURCE_ID
from	
( /* Subselect from WR_SDE_ORA_SalesRepTerritoryDimension.SQ_WC_SALESREP_TERRITORY_DS_NonUSA
*/


select 
	   

	   DISTINCT
	   JRS.SALESREP_ID SALESREP_ID,
	JRS.ORG_ID ORG_ID,
	PPX.EMPLOYEE_NUMBER EMPLOYEE_NUMBER,
	UPPER (NVL (PPX.KNOWN_AS, PPX.FIRST_NAME)) FIRST_NAME,
	UPPER (PPX.LAST_NAME) LAST_NAME,
	DECODE (PPX.LAST_NAME
              ,NULL
              , UPPER (JRDV.RESOURCE_NAME),UPPER (PPX.LAST_NAME)|| ','|| UPPER (NVL (PPX.KNOWN_AS, PPX.FIRST_NAME))
              ) FULL_NAME,
	JRS.SALESREP_NUMBER SALESREP_NUMBER,
	JRDV.RESOURCE_ID RESOURCE_ID,
	JRS.START_DATE_ACTIVE SALESREP_SDTA,
	JRS.END_DATE_ACTIVE SALESREP_EDTA,
	JRS.PERSON_ID PERSON_ID,
	JRS.STATUS SALESREP_STATUS,
	JRS.LAST_UPDATE_DATE LAST_UPDATE_DATE,
	JRS.LAST_UPDATED_BY LAST_UPDATED_BY,
	JRS.CREATION_DATE CREATION_DATE,
	JRS.CREATED_BY CREATED_BY
from	"PC_FIVETRAN_DB"."ERPPRD_JTF"."JTF_RS_SALESREPS"
   JRS, (SELECT  b.RESOURCE_ID , b.CREATED_BY , b.CREATION_DATE , b.LAST_UPDATED_BY , b.LAST_UPDATE_DATE , b.LAST_UPDATE_LOGIN , 
b.CATEGORY , b.RESOURCE_NUMBER , b.SOURCE_ID , b.ADDRESS_ID , b.CONTACT_ID , b.MANAGING_EMPLOYEE_ID , b.START_DATE_ACTIVE , 
b.END_DATE_ACTIVE , b.TIME_ZONE , b.COST_PER_HR , b.PRIMARY_LANGUAGE , b.SECONDARY_LANGUAGE , b.IES_AGENT_LOGIN , b.SERVER_GROUP_ID ,
b.ASSIGNED_TO_GROUP_ID , b.COST_CENTER , b.CHARGE_TO_COST_CENTER , b.COMPENSATION_CURRENCY_CODE , b.COMMISSIONABLE_FLAG , b.HOLD_REASON_CODE ,
b.HOLD_PAYMENT , b.COMP_SERVICE_TEAM_ID , b.TRANSACTION_NUMBER, b.OBJECT_VERSION_NUMBER , b.ATTRIBUTE1 , b.ATTRIBUTE2 , b.ATTRIBUTE3 ,
b.ATTRIBUTE4 , b.ATTRIBUTE5 , b.ATTRIBUTE6 , b.ATTRIBUTE7 , b.ATTRIBUTE8 , b.ATTRIBUTE9 , b.ATTRIBUTE10 , b.ATTRIBUTE11 , b.ATTRIBUTE12 ,
b.ATTRIBUTE13, b.ATTRIBUTE14 , b.ATTRIBUTE15 , b.ATTRIBUTE_CATEGORY , b.USER_ID , b.SUPPORT_SITE_ID , t.RESOURCE_NAME , b.SOURCE_NAME ,
b.SOURCE_NUMBER , b.SOURCE_JOB_TITLE , b.SOURCE_EMAIL , b.SOURCE_PHONE , b.SOURCE_ORG_ID , b.SOURCE_ORG_NAME , b.SOURCE_ADDRESS1 , 
b.SOURCE_ADDRESS2 , b.SOURCE_ADDRESS3 , b.SOURCE_ADDRESS4 , b.SOURCE_CITY , b.SOURCE_POSTAL_CODE , b.SOURCE_STATE , b.SOURCE_PROVINCE , 
b.SOURCE_COUNTY , b.SOURCE_COUNTRY , b.SOURCE_MGR_ID , b.SOURCE_MGR_NAME , b.SOURCE_BUSINESS_GRP_ID , b.SOURCE_BUSINESS_GRP_NAME ,
b.SOURCE_FIRST_NAME , b.SOURCE_MIDDLE_NAME , b.SOURCE_LAST_NAME , b.SOURCE_CATEGORY , b.SOURCE_STATUS , b.USER_NAME , b.SOURCE_OFFICE , 
b.SOURCE_LOCATION, b.SOURCE_MAILSTOP , b.SOURCE_MOBILE_PHONE, b.SOURCE_PAGER, b.SOURCE_JOB_ID, b.PERSON_PARTY_ID, b.FS_SETUP_COMPLETE 
from "PC_FIVETRAN_DB"."ERPPRD_JTF"."JTF_RS_RESOURCE_EXTNS" b, "PC_FIVETRAN_DB"."ERPPRD_JTF"."JTF_RS_RESOURCE_EXTNS_TL" t WHERE t.language = 'US' and b.resource_id = t.resource_id 
and b.category = t.category)   JRDV, "PC_FIVETRAN_DB"."ERPPRD_HR"."HR_ALL_ORGANIZATION_UNITS"
   HOU,(SELECT PERSON_ID, EFFECTIVE_START_DATE, EFFECTIVE_END_DATE, BUSINESS_GROUP_ID, PERSON_TYPE_ID, LAST_NAME, START_DATE, APPLICANT_NUMBER, COMMENT_ID, CURRENT_APPLICANT_FLAG, CURRENT_EMP_OR_APL_FLAG, CURRENT_EMPLOYEE_FLAG, DATE_EMPLOYEE_DATA_VERIFIED, DATE_OF_BIRTH, EMAIL_ADDRESS, EMPLOYEE_NUMBER, EXPENSE_CHECK_SEND_TO_ADDRESS, FIRST_NAME, FULL_NAME, KNOWN_AS, MARITAL_STATUS, MIDDLE_NAMES, NATIONALITY, NATIONAL_IDENTIFIER, PREVIOUS_LAST_NAME, REGISTERED_DISABLED_FLAG, SEX, TITLE, VENDOR_ID, WORK_TELEPHONE, REQUEST_ID, PROGRAM_APPLICATION_ID, PROGRAM_ID, PROGRAM_UPDATE_DATE, ATTRIBUTE_CATEGORY, ATTRIBUTE1, ATTRIBUTE2, ATTRIBUTE3, ATTRIBUTE4, ATTRIBUTE5, ATTRIBUTE6, ATTRIBUTE7, ATTRIBUTE8, ATTRIBUTE9, ATTRIBUTE10, ATTRIBUTE11, ATTRIBUTE12, ATTRIBUTE13, ATTRIBUTE14, ATTRIBUTE15, ATTRIBUTE16, ATTRIBUTE17, ATTRIBUTE18, ATTRIBUTE19, ATTRIBUTE20, ATTRIBUTE21, ATTRIBUTE22, ATTRIBUTE23, ATTRIBUTE24, ATTRIBUTE25, ATTRIBUTE26, ATTRIBUTE27, ATTRIBUTE28, ATTRIBUTE29, ATTRIBUTE30, LAST_UPDATE_DATE, LAST_UPDATED_BY, LAST_UPDATE_LOGIN, CREATED_BY, CREATION_DATE, PER_INFORMATION_CATEGORY, PER_INFORMATION1, PER_INFORMATION2, PER_INFORMATION3, PER_INFORMATION4, PER_INFORMATION5, PER_INFORMATION6, PER_INFORMATION7, PER_INFORMATION8, PER_INFORMATION9, PER_INFORMATION10, PER_INFORMATION11, PER_INFORMATION12, PER_INFORMATION13, PER_INFORMATION14, PER_INFORMATION15, PER_INFORMATION16, PER_INFORMATION17, PER_INFORMATION18, PER_INFORMATION19, PER_INFORMATION20, PER_INFORMATION21, PER_INFORMATION22, PER_INFORMATION23, PER_INFORMATION24, PER_INFORMATION25, PER_INFORMATION26, PER_INFORMATION27, PER_INFORMATION28, PER_INFORMATION29, PER_INFORMATION30, SUFFIX, OBJECT_VERSION_NUMBER, WORK_SCHEDULE, CORRESPONDENCE_LANGUAGE, STUDENT_STATUS, FTE_CAPACITY, ON_MILITARY_SERVICE, SECOND_PASSPORT_EXISTS, BACKGROUND_CHECK_STATUS, BACKGROUND_DATE_CHECK, BLOOD_TYPE, LAST_MEDICAL_TEST_DATE, LAST_MEDICAL_TEST_BY, REHIRE_RECOMMENDATION, REHIRE_AUTHORIZOR, REHIRE_REASON, RESUME_EXISTS, RESUME_LAST_UPDATED, OFFICE_NUMBER, INTERNAL_LOCATION, MAILSTOP, PROJECTED_START_DATE, HONORS, PRE_NAME_ADJUNCT, HOLD_APPLICANT_DATE_UNTIL, COORD_BEN_MED_PLN_NO, COORD_BEN_NO_CVG_FLAG, DPDNT_ADOPTION_DATE, DPDNT_VLNTRY_SVCE_FLAG, RECEIPT_OF_DEATH_CERT_DATE, USES_TOBACCO_FLAG, BENEFIT_GROUP_ID, ORIGINAL_DATE_OF_HIRE, TOWN_OF_BIRTH, REGION_OF_BIRTH, COUNTRY_OF_BIRTH, GLOBAL_PERSON_ID, COORD_BEN_MED_EXT_ER, COORD_BEN_MED_PL_NAME, COORD_BEN_MED_INSR_CRR_NAME, COORD_BEN_MED_INSR_CRR_IDENT, COORD_BEN_MED_CVG_STRT_DT, COORD_BEN_MED_CVG_END_DT, NPW_NUMBER, CURRENT_NPW_FLAG, 
GLOBAL_NAME, LOCAL_NAME FROM "PC_FIVETRAN_DB"."ERPPRD_HR"."PER_ALL_PEOPLE_F" WHERE SYSDATE()  BETWEEN EFFECTIVE_START_DATE AND EFFECTIVE_END_DATE)   PPX
where	(1=1)
 And (JRS.RESOURCE_ID=JRDV.RESOURCE_ID)
AND (JRS.ORG_ID=HOU.ORGANIZATION_ID)
AND (JRS.PERSON_ID=PPX.PERSON_ID (+))

And (((JRS.SALESREP_ID = -3 AND JRS.ORG_ID = 107) OR JRS.SALESREP_ID <> -3))
 And (JRS.SALESREP_ID  IN (                                   
                                SELECT DISTINCT SRT.SALESREP_ID
                                  FROM "PC_FIVETRAN_DB"."ERPPRD_AR"."RA_SALESREP_TERRITORIES"
 SRT
                                  INNER JOIN "PC_FIVETRAN_DB"."ERPPRD_JTF"."JTF_RS_SALESREPS"
 R ON R.SALESREP_ID = SRT.SALESREP_ID
                                  WHERE NOT EXISTS (
                                       SELECT 1
                                        FROM "PC_FIVETRAN_DB"."ERPPRD_JTF"."JTF_RS_SALESREPS"
 JRS1
                                        WHERE JRS1.SALESREP_NUMBER = R.SALESREP_NUMBER       -- RESOURCE_ID
                                          AND JRS1.ORG_ID = 107)
                                ))







)    SQ_WC_SALESREP_TERRITORY_DS LEFT OUTER JOIN 
( /* Subselect from WR_SDE_ORA_SalesRepTerritoryDimension.LKP_RA_SALESREP_TERRITORIES_USA
*/
SELECT 
      rtnonusa.territory_id             AS X_TERRITORY_ID
     ,rtnonusa.NAME                     AS   X_TERRITORY_NAME
     ,'ALL'                             AS  X_TOP
     ,rtnonusa.segment1                 AS  X_SUPERGEO
     ,rtnonusa.segment2                 AS  X_DIVISION
     ,rtnonusa.segment3                 AS  X_REGION
     ,rtnonusa.segment4                 AS  X_DISTRICT
     ,multiplex.dups                    AS X_SALESREP_ID
FROM "PC_FIVETRAN_DB"."ERPPRD_AR"."RA_TERRITORIES"
 rtnonusa, "PC_FIVETRAN_DB"."ERPPRD_AR"."RA_SALESREP_TERRITORIES"
 rstnonusa
     , (SELECT   MAX (aa.start_date_active) start_date
                ,aa.salesrep_id
            FROM "PC_FIVETRAN_DB"."ERPPRD_AR"."RA_SALESREP_TERRITORIES"
 aa
        GROUP BY aa.salesrep_id) latest_rec
     ,(
        SELECT SRID.salesrep_id, SRID2.salesrep_id dups,SRID.salesrep_number, SRID.primary_flg
        FROM 
            (
              SELECT DISTINCT row_number() over (ORDER BY NULL) seq, aa.salesrep_id,aa.salesrep_number
                          , case when org_id=107 then 1 else 0 end primary_flg
                          FROM "PC_FIVETRAN_DB"."ERPPRD_JTF"."JTF_RS_SALESREPS"
 aa
              ) SRID,
            (
              SELECT DISTINCT row_number() over (ORDER BY NULL)  seq, aa.salesrep_id,aa.salesrep_number
                          , 0 primary_flg
                          FROM "PC_FIVETRAN_DB"."ERPPRD_JTF"."JTF_RS_SALESREPS"
 aa
              ) SRID2     
        WHERE SRID.salesrep_number=SRID2.salesrep_number 
        ) multiplex 
WHERE rstnonusa.territory_id = rtnonusa.territory_id
  AND rstnonusa.salesrep_id = latest_rec.salesrep_id
  AND rstnonusa.start_date_active = latest_rec.start_date
  AND rstnonusa.salesrep_id = multiplex.salesrep_id
  AND multiplex.primary_flg=1

)    LKP_RA_SALESREP_TERRITORIES ON SQ_WC_SALESREP_TERRITORY_DS.SALESREP_ID=LKP_RA_SALESREP_TERRITORIES.X_SALESREP_ID
where	(1=1)

),

FINAL_NONUSA as (
select	
	X_SALESREP_ID,
	X_TERRITORY_ID,
	X_ORG_ID,
	X_TOP,
	X_SUPERGEO,
	X_DIVISION,
	X_REGION,
	X_DISTRICT,
	X_TERRITORY_NAME,
	X_EMP_NUM,
	X_FIRST_NAME,
	X_LAST_NAME,
	X_FULL_NAME,
	CREATED_BY_ID,
	CHANGED_BY_ID,
	CREATED_ON_DT,
	CHANGED_ON_DT,
	AUX1_CHANGED_ON_DT,
	SRC_EFF_FROM_DT,
	SRC_EFF_TO_DT,
	INTEGRATION_ID,
	X_SALESREP_NUM,
	X_RESOURCE_ID,
	'N' DELETE_FLG,
	380 DATASOURCE_NUM_ID,
	'DEFAULT' X_CUSTOM
FROM (	


select 	
	DISTINCT
	C1_X_SALESREP_ID X_SALESREP_ID,
	C2_X_TERRITORY_ID X_TERRITORY_ID,
	C3_X_ORG_ID X_ORG_ID,
	C4_X_TOP X_TOP,
	C5_X_SUPERGEO X_SUPERGEO,
	C6_X_DIVISION X_DIVISION,
	C7_X_REGION X_REGION,
	C8_X_DISTRICT X_DISTRICT,
	C9_X_TERRITORY_NAME X_TERRITORY_NAME,
	C10_X_EMP_NUM X_EMP_NUM,
	C11_X_FIRST_NAME X_FIRST_NAME,
	C12_X_LAST_NAME X_LAST_NAME,
	C13_X_FULL_NAME X_FULL_NAME,
	C14_CREATED_BY_ID CREATED_BY_ID,
	C15_CHANGED_BY_ID CHANGED_BY_ID,
	C16_CREATED_ON_DT CREATED_ON_DT,
	C17_CHANGED_ON_DT CHANGED_ON_DT,
	C18_AUX1_CHANGED_ON_DT AUX1_CHANGED_ON_DT,
	C19_SRC_EFF_FROM_DT SRC_EFF_FROM_DT,
	C20_SRC_EFF_TO_DT SRC_EFF_TO_DT,
	C21_INTEGRATION_ID INTEGRATION_ID,
	C22_X_SALESREP_NUM X_SALESREP_NUM,
	C23_X_RESOURCE_ID X_RESOURCE_ID 
from  ST_NONUSA
where		(1=1)	






)    ODI_GET_FROM
)

SELECT * FROM FINAL_NONUSA
